<!DOCTYPE html>
<html>
<head>

	<title>PaperTrue Time Converter</title>

	<link rel="stylesheet" href="bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css" />
	<link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <!--<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>-->
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
	<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
	<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script type="text/javascript" src="moment/moment.js"></script>
	<script type="text/javascript" src="bootstrap/js/transition.js"></script>
	<script type="text/javascript" src="bootstrap/js/collapse.js"></script>
	<script type="text/javascript" src="bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>

	<script>
	
	var geocoder;
	var count  = -1;
	var count1 = 0;
	var flag = 0;
	var cityOneOffset = 0;
	var monthNames = ["January", "February", "March", "April", "May", "June","July", "August", "September", "October", "November", "December"];
	var weekNames = ["Sunday", "Monday" , "Tuesday" , "Wednesday" , "Thursday" , "Friday", "Saturday"];
	var autocompleteCityOne;
	var autocompleteCityTwo;

	function initialize() {

      //Adds Google Places Auto Complete to the city fields.
      
      autocompleteCityOne = new google.maps.places.Autocomplete( (document.getElementById('city1')), { types: ['(cities)'] });

      autocompleteCityTwo = new google.maps.places.Autocomplete( (document.getElementById('city2')), { types: ['(cities)'] });
      
      google.maps.event.addListener(autocompleteCityOne, 'place_changed', function() {
      });
      
      google.maps.event.addListener(autocompleteCityTwo, 'place_changed', function() {
      });
    
    }

    function initializeConversion() {
    	//Gets the coordinates of both cities
    	getCoordinates(document.getElementById('city1').value);
    	getCoordinates(document.getElementById('city2').value);
    }

    function getCoordinates(city) {
    	
    	//Gets the coordinates of the city passed

		var address = city;
		var count=0;
		
		geocoder = new google.maps.Geocoder();

		geocoder.geocode( { 'address': address}, function(results, status) {

			if (status == google.maps.GeocoderStatus.OK) {

				console.log(results[0].geometry.location.A);
				console.log(results[0].geometry.location.F);

				longitude=results[0].geometry.location.A;
				latitude=results[0].geometry.location.F;
				
				generateRequestURL(latitude,longitude);

			} else {
				alert('Geocode was not successful for the following reason: ' + status);
			}
		});	
	}

	function generateRequestURL(latitude, longitude) {

		var timestamp;
		var apiKey = "AIzaSyB4bGs5nvF2cvmCrTm77fv_Mv0XiKqKORY";
		//var myDate = new Date(document.getElementById('date1').value);
		//timestamp2 = Math.round(myDate.getTime()/1000.0);

		if( document.getElementById('date1').value.length == 0) {
				
				if( document.getElementById('date2').value.length == 0 && count1 == 1) {
					flag = 0;
					alert("Please choose date and time of one of the cities!");
					location.reload();
				}
				else 
					flag = 2;
			}
			else {
				flag=1;
			}
		if(flag == 1 ) {
				
				var myDate = new Date(document.getElementById('date1').value);
				
				timestamp = Math.round(myDate.getTime()/1000.0);
				console.log("Date: "+ document.getElementById('date1').value + "Timestamp: "+timestamp);
				
				var calculatedLocation = longitude + "," + latitude;
				var url = "https://maps.googleapis.com/maps/api/timezone/json?location=" + calculatedLocation + "&timestamp=" + timestamp + "&key=" + apiKey;
				
				console.log(url);
			    getConvertedTime(url,timestamp);					
			}

		if(flag == 2 ) {
				
				var myDate = new Date(document.getElementById('date2').value);
				
				timestamp = Math.round(myDate.getTime()/1000.0);
				console.log("Date: "+ document.getElementById('date2').value + "Timestamp: "+timestamp);
				
				var calculatedLocation = longitude + "," + latitude;
				var url = "https://maps.googleapis.com/maps/api/timezone/json?location=" + calculatedLocation + "&timestamp=" + timestamp + "&key=" + apiKey;
				
				console.log(url);
			    getConvertedTime(url,timestamp);	
			}	
		count1++;	
	}

	function addZero(i) {
		
		if (i < 10) {
			i = "0" + i;
		}
		return i;

	}

	function getConvertedTime(url,timestamp){
		console.log("Entered");
    	var Httpreq = new XMLHttpRequest(); // a new request
    	
    	Httpreq.open("GET",url,false);
    	Httpreq.send(null);
    	
    	var result = Httpreq.responseText;
    	var jsonObj = JSON.parse(result);

    if( count == -1 ) {
    		cityOneOffset = jsonObj.dstOffset + jsonObj.rawOffset;
    	}

    	var convertedTimeStamp = timestamp + jsonObj.dstOffset + jsonObj.rawOffset - cityOneOffset;
    	var convertedTime = new Date(convertedTimeStamp*1000);

    	if(count == 0 ) {
    		console.log("Time:"+convertedTime);
    		var suffix = "AM";
    		var hours = convertedTime.getHours();

    		if ( hours >= 12) {
    			suffix = "PM";
    			hours = hours-12;
    		}

    		var fullConvertedTime = ( weekNames [ convertedTime.getDay() ] + ", " + 
    			monthNames [ convertedTime.getMonth() ] + " " + 
    			addZero(convertedTime.getDate() ) + ", " + 
    			addZero(convertedTime.getFullYear()) + " " +
    			addZero( hours )+ ":" +
    			addZero(convertedTime.getMinutes() ) + " " +
    			suffix
    			);
    		console.log(fullConvertedTime);
    		count = -2;	
    		cityOneOffset=0;
    	}

    	count++;
    }

	</script>

</head>
<body onload="initialize()">

	<div class="container">
		<div class="row">
			<div class="col-md-12">
				<p id="enterdate"> Time <input id = "date1" placeholder="Choose time in city one" type = "text" value = "" />
				in <input id="city1" placeholder="Enter city one" type="text" autocomplete="off"></input></p>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<p id="enterdate"> Time <input id = "date2" placeholder="Choose time in city two" type = "text" value = "" />
				in <input id="city2" placeholder="Enter city two" type="text" value="Pune" autocomplete="off"></input></p>
				<input id = "submit2" align = "center" type = "button" value ="Submit" onclick = "initializeConversion()" />
			</div>
		</div>
	</div>
	<script>
			$(function () {
				$('#date1').datetimepicker();
				$('#date2').datetimepicker();
			});
	</script>
</body>	
</html>